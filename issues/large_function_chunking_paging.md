# 巨大関数の簡易的な小チャンク化（ページング）

## 概要

既存の `get_function_chunk` および `get_chunk` ツールが返すコードチャンクが一定以上の大きさである場合に、そのチャンクをページング可能にする機能を追加します。これにより、巨大な関数でも扱いやすいサイズで取得できるようになります。

## 詳細

### 優先度

高

### 問題点

- 巨大な関数を一度に取得すると、LLMのコンテキストウィンドウを圧迫したり、処理が重くなる可能性があります。
- 意味的な分割は複雑であるため、まずは簡易的なページング機能で対応します。

### 提案仕様

#### 対象ツール

- [x] `get_function_chunk`: 特定の関数のコードチャンクを取得するツール。
- [x] `get_chunk`: チャンクIDでコードチャンクを取得するツール。

#### ページングのトリガー

- [x] チャンクの `content` の行数、またはバイト数が、定義された閾値（例: 500行、10KBなど）を超えた場合にページングを適用します。閾値は設定可能にするのが望ましいです。

#### 応答の追加情報

既存の `CodeChunk` インターフェースに以下のフィールドを追加することを検討します。

- [x] `isPartial: boolean`: このチャンクが完全なコードチャンクの一部である場合に `true`。
- [x] `totalLines: number` (オプション): 元の巨大関数の総行数。
- [x] `currentPage: number` (オプション): 現在のチャンクが何ページ目か。
- [x] `totalPages: number` (オプション): 元の巨大関数の総ページ数。
- [x] `nextPageToken: string` (オプション): 次のページをリクエストするためのトークン。
- [x] `prevPageToken: string` (オプション): 前のページをリクエストするためのトークン。

また、`content` プロパティの先頭に、以下の情報を自然言語で追記します。

- [ ] **部分出力の明示**: 「この関数は巨大なため、一部のみを表示しています。」
- [ ] **全体に対する部分の明示**: 「(現在のページ)/(総ページ数)ページ目、(開始行)-(終了行)行目」
- [ ] **次の/前の部分のリクエスト方法**: 「次の部分を取得するには、`get_function_chunk` ツールに `pageToken: "[nextPageTokenの値]"` を指定してリクエストしてください。」（`get_chunk` の場合も同様に記載）

#### リクエストの追加引数

`get_function_chunk` および `get_chunk` ツールに以下のオプショナルな引数を追加します。

- [x] `pageToken: string` (オプション): 次のページまたは前のページをリクエストするためのトークン。
- [x] `pageSize: number` (オプション): 1ページあたりの行数またはバイト数を指定。デフォルト値はサーバー側で定義。

#### ページングのロジック

- [x] サーバー側で、`pageToken` を解析し、対応するチャンクの範囲を特定します。
- [x] `pageToken` は、ファイルパス、関数シグネチャ、開始オフセット、終了オフセット、ページサイズなどの情報をエンコードした文字列とします。これにより、ステートレスなページングが可能になります。

## その他

ロードマップの「フェーズ3: 高度なコード理解機能」の「3.2. コードチャンクの粒度拡張」に関連します。
