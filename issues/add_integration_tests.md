# 統合テストの追加

## 概要

MCPサーバーが標準入出力（stdin/stdout）を介してLLM/Agentと正しく対話できることを検証するため、実動作に近い統合テストを追加する。これにより、サーバーの起動からツール呼び出し、応答までのエンドツーエンドのフローを網羅的にテストし、システムの信頼性を向上させる。

## 目的

- MCPサーバーが標準入出力からのツール呼び出しを正しく処理し、期待される応答を返すことを確認する。
- `analyze_project`, `get_chunk`, `list_functions_in_file`, `get_function_chunk`, `find_file`, `find_function` など、主要なツールのエンドツーエンドの動作を検証する。
- エラーケース（例: 存在しないチャンクIDの要求、不正な入力）に対するサーバーの応答をテストする。
- サーバーの起動と終了が適切に行われることを確認する。

## 提案されるテストアプローチ

Node.jsの `child_process.spawn` を使用してMCPサーバープロセスを起動し、テストスクリプトからサーバーの標準入出力を制御する。

### テストシナリオ例

1.  **`analyze_project` ツールのテスト**:
    - テスト用のダミープロジェクトを作成し、`analyze_project` ツールを呼び出す。
    - サーバーが「Project analysis completed.」のような成功メッセージを返すことを検証する。
    - 生成されたチャンクファイルが `data/chunks` ディレクトリに存在することを確認する（オプション）。
2.  **`get_chunk` ツールのテスト**:
    - `analyze_project` で生成されたチャンクIDを使用して `get_chunk` ツールを呼び出す。
    - 期待されるチャンクの内容が返されることを検証する。
    - 存在しないチャンクIDを要求した場合に、エラーメッセージと `isError: true` が返されることを検証する。
3.  **`list_functions_in_file` ツールのテスト**:
    - テスト用のソースファイル（Swift/Kotlin）に対して `list_functions_in_file` ツールを呼び出す。
    - 期待される関数シグネチャのリストがJSON形式で返されることを検証する。
4.  **`get_function_chunk` ツールのテスト**:
    - テスト用のソースファイルと関数シグネチャに対して `get_function_chunk` ツールを呼び出す。
    - 期待される関数のコード内容が返されることを検証する。
    - 存在しない関数シグネチャを要求した場合に、エラーメッセージと `isError: true` が返されることを検証する。
5.  **`find_file` ツールのテスト**:
    - テスト用のファイル構造に対して `find_file` ツールを呼び出す。
    - 期待されるファイルパスのリストがJSON形式で返されることを検証する。
6.  **`find_function` ツールのテスト**:
    - テスト用のソースファイルと関数クエリに対して `find_function` ツールを呼び出す。
    - 期待される関数IDとシグネチャのリストがJSON形式で返されることを検証する。

## 作業項目

- `src/__tests__/integration/` ディレクトリを作成する。
- `integration.test.ts` のような統合テストファイルを作成する。
- テスト用のダミープロジェクトやソースファイルを準備する。
- `child_process.spawn` を使用してサーバープロセスを起動・制御するヘルパー関数を実装する。
- 上記「テストシナリオ例」に基づき、各ツールの統合テストケースを記述する。
- テストの実行方法を `package.json` に追加する（例: `npm run test:integration`）。

## チェックリスト

- [ ] `src/__tests__/integration/` ディレクトリが作成された。
- [ ] 統合テストファイルが作成された。
- [ ] サーバープロセスを起動・制御するヘルパー関数が実装された。
- [ ] `analyze_project` ツールの統合テストが記述された。
- [ ] `get_chunk` ツールの統合テストが記述された。
- [ ] `list_functions_in_file` ツールの統合テストが記述された。
- [ ] `get_function_chunk` ツールの統合テストが記述された。
- [ ] `find_file` ツールの統合テストが記述された。
- [ ] `find_function` ツールの統合テストが記述された。
- [ ] エラーケースに対するテストが記述された。
- [ ] `package.json` に統合テストの実行スクリプトが追加された。
