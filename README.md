# MCP Code Analysis Server

## 概要

このプロジェクトは、大規模言語モデル（LLM）が広範なコードベースを理解し、操作するのを容易にするためのMCP（Model Context Protocol）サーバーの実装です。大規模なソースコードファイルをより小さく、管理しやすい「コードチャンク」に分割し、それらの保存と取得を管理することを主な目的としています。

**本プロジェクトのコードの大部分は、Gemini 2.5 Flashによって生成されており、プログラマの介入は最低限に抑えられています。**

## 機能

### 現在実装済みの機能

- **MCPサーバー実装**: TypeScriptとNode.jsを使用し、`@modelcontextprotocol/sdk` を活用して構築されています。
- **コードチャンク化**: Swiftソースファイルを解析し、関数単位でコードチャンクを抽出します。外部ツールとしてSourceKittenを使用しています。**Kotlinソースファイルの解析もサポートしており、クラス内の関数やプロパティも正確に抽出できます。**
  - `getLineNumber` メソッドの正確性を向上させ、`SourceKitten` のオフセット情報から正確な行番号を導出済みです。
  - **パーサーの分割**: `src/parser.ts` を `src/swiftParser.ts` と `src/kotlinParser.ts` に分割し、各言語の解析ロジックを独立させました。
- **ローカルストレージとキャッシュ**: 解析されたコードチャンクは、メモリキャッシュとファイルキャッシュの2層構造で管理されます。メモリキャッシュはLRUポリシーに基づいて自動的に破棄され、`data/chunks/` ディレクトリにJSONファイルとして永続化されたファイルキャッシュから必要に応じて読み込まれます。
  - `analyzeProject` の `getSwiftFiles` ダミー実装を、指定されたプロジェクトパス内のすべての `.swift` ファイルを再帰的に探索する実際のロジックに置き換え済みです。
- **ツール**: 以下のツールが実装されています。
  - `analyze_project`: 指定されたプロジェクトを解析し、コードチャンクを抽出・保存します。**LLMが次のアクションを判断しやすいよう、自然言語による補足情報を含むレスポンスを返します。**
  - `get_chunk`: 指定されたチャンクID（関数のシグネチャ）に対応するコードチャンクの内容を返します。
  - `list_functions_in_file`: 指定されたファイルに含まれる関数の一覧（シグネチャ）を返します。**LLMが次のアクションを判断しやすいよう、自然言語による補足情報を含むレスポンスを返します。**
  - `get_function_chunk`: 指定されたファイル内の特定の関数のコードチャンク（内容）を返します。**LLMが次のアクションを判断しやすいよう、自然言語による補足情報を含むレスポンスを返します。**
  - `find_file`: 指定されたパターンに一致するファイルを検索します。
  - `find_function`: 指定されたファイル内で、クエリに一致する関数を検索します。

### 将来実装予定の機能

詳細なロードマップは [開発ロードマップ](doc/roadmap.md) を参照してください。

- **テストカバレッジの不足箇所の解消**: 各コンポーネントのエラーケースや特定のメソッドのテストを追加し、テストカバレッジの不足を解消します。
- **テスト粒度とモックの改善**: 各コンポーネントの単体テストを導入し、モックを利用してテストの独立性と実行速度を向上させます。
- **コンストラクタにおける型キャストの解消**: `SwiftParser` のコンストラクタにおける不要な型キャストを解消し、型安全性を向上させます。
- **Kotlin対応のパフォーマンス最適化**: 大規模なKotlinコードベースを解析する際のパフォーマンスボトルネックを特定し、最適化を行います。
- **依存関係グラフの解析と保持**: コードチャンク間の依存関係を解析し、インメモリで保持します。
- **コードチャンクの粒度拡張**: 関数だけでなく、変数、プロパティ、クラス、パッケージなど、より多様な単位でコードチャンクを抽出・管理できるように機能を拡張します。
- **セマンティック検索の導入**: コードチャンクや依存関係グラフを利用して、より高度なセマンティック検索機能（例: 特定の機能に関連するコードの検索）を実装します。
- **ナレッジグラフ構築機能の強化**: 変数・プロパティのデータフロー、関数コールグラフ、クラスの関係、入れ子関係の解析機能を追加します。
- **ナレッジグラフの永続化**: 現状メモリ上にしかないナレッジグラフをローカルに閉じたファイルベースDBとして永続化します。
- **ナレッジグラフの図表化機能の追加**: シーケンス図、クラス図、オブジェクト図、コールグラフ図、データフロー図、一覧表、インターフェイス仕様書（Swaggerなど）の生成機能を追加します。
- **LLMフレンドリーなサーバーレスポンスの改善**: MCPサーバーからのレスポンスに自然言語による補足を追加し、LLMがより適切に情報を解釈し、次のアクションを判断できるようにします。
- **サーバーのパッケージングとデプロイ**: サーバーをスタンドアロンアプリケーションとしてパッケージングし、配布を容易にします。

## はじめに

### 前提条件

- Node.js (v18以上を推奨)
- npm
- Java Development Kit (JDK) v21以上 (Kotlinコード解析のため)
- Gradle (Kotlin CLIツールのビルドのため)

### インストール

1.  リポジトリをクローンします。
    ```bash
    git clone [リポジトリのURL]
    cd [プロジェクトディレクトリ]
    ```
2.  依存関係をインストールします。
    ```bash
    npm install
    ```
3.  SourceKittenをインストールします。（Swiftコード解析のため）
    ```bash
    npm run install-sourcekitten
    ```
4.  Kotlin AST JSON出力CLIツールをビルドします。（Kotlinコード解析のため）
    ```bash
    npm run build-kotlin-parser-cli
    ```

## テストの実行

プロジェクトのテストはVitestを使用しています。

```bash
npm test
```

統合テストの実行:

```bash
npm run test:integration
```

## 図のレンダリング

### 設定方法

1.  **PlantUML JARファイルの配置**:
    `tools/plantuml/` ディレクトリに `plantuml.jar` ファイルを配置してください。
    もし存在しない場合は、以下のコマンドでダウンロードできます。

    ```bash
    mkdir -p tools/plantuml
    curl -L -o tools/plantuml/plantuml.jar https://github.com/plantuml/plantuml/releases/download/v1.2024.5/plantuml.jar
    ```

    **注意**: `plantuml.jar` は `.gitignore` に追加されており、Git管理の対象外です。

### 手動でのレンダリング

`npm run render-diagrams` コマンドを実行することで、手動で図をレンダリングすることも可能です。

```bash
npm run render-diagrams
```

## 使用方法

### MCPサーバーの起動とAgentからの利用

MCPサーバーを起動するには、以下のコマンドを実行します。

```bash
npm start
```

サーバーが起動したら、Continue, Claude Code, gemini-cliなどのAgentからMCPサーバーを利用するための設定例は [MCPサーバー設定ファイル例](doc/mcp_settings.md) を参照してください。

### LLMからのツール利用例

MCPサーバーはLLMからのツール呼び出しを想定しています。以下は、LLMがサーバーにリクエストする際のプロンプトの例です。

#### プロジェクトの解析

「このプロジェクトのコードベースを解析して、主要な関数と構造を把握してください。」

#### ファイル内の関数一覧の取得

「`src/MyFile.swift` に含まれるすべての関数のシグネチャを教えてください。」

#### 特定の関数のコードチャンクの取得

「`src/MyFile.swift` の `func myFunction(param: String) -> Int` 関数の実装コードを教えてください。」

#### チャンクIDを指定してコードチャンクを取得

「チャンクID `func yourFunction(param:) -> Int` のコード内容を教えてください。」

## 貢献

貢献を歓迎します！バグ報告や機能提案については、Issueトラッカーをご利用ください。

## ライセンス

[ライセンス情報] (例: MIT License)
