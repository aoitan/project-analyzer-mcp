@startuml

actor "LLM/Agent" as LLM
participant "MCP Server" as Server
participant "AnalysisService" as AS
participant "ParserFactory" as PF
participant "SwiftParser" as SP
participant "KotlinParser" as KP
participant "SourceKitten" as SK
participant "Kotlin CLI" as KCLI
participant "File System" as FS

== get_function_chunk ==
LLM -> Server: callTool("get_function_chunk", { filePath: "...", functionSignature: "..." })
activate Server
Server -> AS: getFunctionChunk(filePath, functionSignature)
activate AS
AS -> PF: getParser(language)
activate PF
PF --> AS: parser
deactivate PF
AS -> parser: parseFile(filePath)
activate parser
parser -> FS: readFile(filePath)
activate FS
FS --> parser: fileContent
deactivate FS
alt if Swift file
  parser -> SK: structure --file filePath
  activate SK
  SK --> parser: JSON output
  deactivate SK
else if Kotlin file
  parser -> KCLI: java -jar kotlin-parser-cli.jar filePath
  activate KCLI
  KCLI --> parser: JSON output
  deactivate KCLI
end
parser --> AS: CodeChunk[]
deactivate parser
AS --> Server: functionContent
deactivate AS
Server --> LLM: { content: [{ type: "text", text: "..." }] }
alt function not found
  Server --> LLM: { content: [{ type: "text", text: "Function chunk not found." }], isError: true }
else function found
  Server --> LLM: { content: [{ type: "text", text: "..." }] }
end
deactivate Server

@enduml