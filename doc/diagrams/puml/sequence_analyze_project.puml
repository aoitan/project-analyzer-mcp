@startuml

actor "LLM/Agent" as LLM
participant "MCP Server" as Server
participant "AnalysisService" as AS
participant "ParserFactory" as PF
participant "SwiftParser" as SP
participant "KotlinParser" as KP
participant "SourceKitten" as SK
participant "Kotlin CLI" as KCLI
participant "File System" as FS
participant "Glob Library" as GL

== analyze_project ==
LLM -> Server: callTool("analyze_project", { projectPath: "..." })
activate Server
Server -> AS: analyzeProject(projectPath)
activate AS
AS -> FS: rm(chunksDir, recursive: true, force: true)
activate FS
FS --> AS: success
deactivate FS
AS -> FS: mkdir(chunksDir, recursive: true)
activate FS
FS --> AS: success
deactivate FS
AS -> GL: glob("**/*.swift", { cwd: projectPath, absolute: true })
activate GL
GL --> AS: swiftFiles
deactivate GL
AS -> GL: glob("**/*.kt", { cwd: projectPath, absolute: true })
activate GL
GL --> AS: kotlinFiles
deactivate GL
loop for each file in allFiles
  AS -> PF: getParser(language)
  activate PF
  PF --> AS: parser (SP or KP)
  deactivate PF
  alt if Swift file
    AS -> SP: parseFile(filePath)
    activate SP
    SP -> SK: structure --file filePath
    activate SK
    SK --> SP: JSON output
    deactivate SK
    SP -> FS: readFile(filePath)
    activate FS
    FS --> SP: fileContent
    deactivate FS
    SP --> AS: CodeChunk[]
    deactivate SP
  else if Kotlin file
    AS -> KP: parseFile(filePath)
    activate KP
    KP -> KCLI: java -jar kotlin-parser-cli.jar filePath
    activate KCLI
    KCLI --> KP: JSON output
    deactivate KCLI
    KP -> FS: readFile(filePath)
    activate FS
    FS --> KP: fileContent
    deactivate FS
    KP --> AS: CodeChunk[]
    deactivate KP
  end
  AS -> FS: saveChunk(CodeChunk)
  activate FS
  FS --> AS: saved
  deactivate FS
  AS -> AS: add to parsedProjects cache
end
AS --> Server: analysis completed
deactivate AS
Server --> LLM: { content: [{ type: "text", text: "Project analysis completed." }] }
deactivate Server

@enduml